# Apache Arrow

[Apache Arrow](https://arrow.apache.org/) æ˜¯ä¸€ç§ç‰¹åˆ«çš„æ•°æ®æ ¼å¼, å¸®åŠ©æˆ‘ä»¬å¯¹å¤§è§„æ¨¡æ•°æ®é›†ä¹Ÿå¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œç§»åŠ¨å’Œå¤„ç†. å®ƒæœ‰ä»¥ä¸‹çš„ä¼˜ç‚¹:

- é‡‡ç”¨äº†**é›¶æ‹·è´**(zero-copy)è¯»å–æŠ€æœ¯, æ¶ˆé™¤äº†**åºåˆ—åŒ–**çš„å¼€é”€
- å®ƒæ˜¯ä¸ç¼–ç¨‹è¯­è¨€æ— å…³çš„, æ”¯æŒä¸åŒçš„ç¼–ç¨‹è¯­è¨€
- Arrowæ˜¯é¢å‘åˆ—çš„, å› æ­¤æŸ¥è¯¢å’Œå¤„ç†æ•°æ®ç‰‡æˆ–æ•°æ®åˆ—çš„é€Ÿåº¦æ›´å¿«
- Arrowå…è®¸æ— å¤åˆ¶åˆ‡æ¢åˆ°æ ‡å‡†æœºå™¨å­¦ä¹ å·¥å…·, å¦‚NumPy, Pandas, PyTorchå’ŒTensorFlow
- Arrowæ”¯æŒåµŒå¥—çš„åˆ—ç±»å‹

# å†…å­˜æ˜ å°„

HF Datasets å€ŸåŠ© Arrow ä½œä¸º **local caching system**. è¿™æ˜¯ä¸€ç§ç”±**ç£ç›˜ç¼“å­˜**(on-disk cache)ä¸ºæ•°æ®æä¾›æ”¯æŒçš„æŠ€æœ¯, ç£ç›˜ç¼“å­˜å†ç”±å†…å­˜æä¾›æ˜ å°„(memory-mapped), å®ç°å¿«é€Ÿå®šä½æŸ¥æ‰¾.

è¿™ç§æ¶æ„ä½¿å¾—åœ¨å°å†…å­˜æœºå™¨ä¸Š, å°±èƒ½å¯¹å¤§æ•°æ®é›†è¿›è¡ŒåŠ è½½. **Arrow data å¹¶ä¸ä¼šç›´æ¥ä¿å­˜åœ¨å†…å­˜ä¸­, è€Œæ˜¯ä¿å­˜åœ¨ç£ç›˜ä¸­, å†…å­˜ä¸­ä¿å­˜çš„æ˜¯æ˜ å°„è¡¨, æä¾›åœ¨ç£ç›˜ä¸­è·å–æ•°æ®çš„é€šé“.** å¹¶å€ŸåŠ©è™šæ‹Ÿå†…å­˜å®ç°å¿«é€ŸæŸ¥æ‰¾.

```python
import os; import psutil; import timeit
from datasets import load_dataset

# Process.memory_info is expressed in bytes, so convert to megabytes 
mem_before = psutil.Process(os.getpid()).memory_info().rss / (1024 * 1024)
wiki = load_dataset("wikipedia", "20220301.en", split="train")
mem_after = psutil.Process(os.getpid()).memory_info().rss / (1024 * 1024)

print(f"RAM memory used: {(mem_after - mem_before)} MB")
# RAM memory used: 50 MB
```

ä¸Šé¢çš„ä¾‹å­ä¸­åŠ è½½çš„æ˜¯å®Œæ•´çš„è‹±æ–‡ç»´åŸºç™¾ç§‘æ•°æ®é›†, å´åªå ç”¨äº† `50 MB` çš„å†…å­˜.

# ç¼“å­˜

ç¼“å­˜æ˜¯ Datasets è¡¨ç°é«˜æ•ˆçš„ä¸€ä¸ªé‡è¦åŸå› . Datasets ç¼“å­˜äº†ä¸‹è½½çš„æ•°æ®é›†ä»¥åŠå¤„ç†å¾—åˆ°çš„æ•°æ®é›†, å½“åœ¨æ­¤ç”¨åˆ°è¿™äº›æ•°æ®æ—¶, ä¼šé‡æ–°ä»ç¼“å­˜ä¸­åŠ è½½, è€Œä¸æ˜¯é‡æ–°ä¸‹è½½æˆ–è€…å†æ¬¡è¿è¡Œå¤„ç†å‡½æ•°å¾—åˆ°ç»“æœ.

## Fingerprint

ç¼“å­˜çš„ä¸€ä¸ªå…³é”®é—®é¢˜æ˜¯**å¦‚ä½•è®°å½•å“ªäº›å¤„ç†é€»è¾‘åº”ç”¨åˆ°äº†æ•°æ®é›†ä¸Š**. Datasets é€šè¿‡ **fingerprint** æœºåˆ¶å®ç°. fingerprint å¯¹æ•°æ®é›†çš„å½“å‰çŠ¶æ€è¿›è¡Œè·Ÿè¸ªè®°å½•. åˆå§‹çš„ fingerprint æ˜¯é€šè¿‡å¯¹ Arrow table(æ•°æ®é›†æ¥è‡ªå†…å­˜, å¦‚pandas DataFrame) æˆ–è€… Arrow files(æ•°æ®é›†åœ¨ç£ç›˜ä¸­) è¿›è¡Œ hash compute å¾—åˆ°çš„. åç»­çš„ fingerprints ç”± **å‰åºçš„ fingerprints** ä»¥åŠåœ¨**æ•°æ®é›†ä¸Šçš„æœ€åä¸€æ­¥è½¬æ¢å¯¹åº”çš„ hash å€¼** ç»¼åˆè®¡ç®—å¾—åˆ°. è¿™é‡Œè¯´çš„è½¬æ¢åŒ…æ‹¬[å¯¹æ•°æ®é›†è¿›è¡Œé‡æ–°å¸ƒç½®](/docs/framework/datasets/å¯¹æ•°æ®é›†è¿›è¡Œé‡æ–°å¸ƒç½®.md)ä¸­æåˆ°çš„æ‰€æœ‰æ“ä½œ.

fingerprint å®é™…ä¸­ä¸º:

```python
from datasets import Dataset
dataset1 = Dataset.from_dict({"a": [0, 1, 2]})
dataset2 = dataset1.map(lambda x: {"a": x["a"] + 1})
print(dataset1._fingerprint, dataset2._fingerprint)
# d19493523d95e2dc 5b86abacd4b42434
```

è½¬æ¢æ“ä½œå¿…é¡»æ˜¯å¯å“ˆå¸Œçš„, å®ƒå¯ä»¥è¢« dill æˆ–è€… pickle åºåˆ—åŒ–. å¦‚æœä½¿ç”¨äº†ä¸€ä¸ªä¸å¯å“ˆå¸Œçš„è½¬æ¢æ“ä½œ, Datasets å¹¶ä¸ä¼šæŠ¥é”™, è€Œæ˜¯ç”Ÿæˆä¸€ä¸ªéšæœºçš„ fingerprints, å¹¶ä¼šæŠ›å‡ºä¸€ä¸ª warning. ä½†ç”±äºä¸­é—´æœ‰ fingerprints çš„è®¡ç®—ä¸­æ–­äº†(ç”±å‰åº+è½¬æ¢æ“ä½œhash, å˜æˆäº†éšæœº), ä»˜å‡ºçš„ä»£ä»·æ˜¯å†æ¬¡ä½¿ç”¨è¿™ä¸ªæ•°æ®æ—¶, ä¼šé‡æ–°å¯¹æ‰€æœ‰çš„è½¬æ¢è®¡ç®—ä¸€é. è¿™å°†ä¼šæ˜¯éå¸¸è€—æ—¶çš„. å› æ­¤ä¸€å®šè¦ä¿è¯è½¬æ¢å‡½æ•°å¯ä»¥è¢«åºåˆ—åŒ–.

ç¼“å­˜æœºåˆ¶æ˜¯å¯ä»¥å…³é—­çš„. å…³é—­ä¹‹å, åœ¨æ¯æ¬¡å¯åŠ¨ Python session å¤„ç†æ•°æ®æ—¶, éƒ½ä¼šåœ¨ä¸´æ—¶ç›®å½•ä¸­åˆ›å»ºç¼“å­˜æ–‡ä»¶, å½“ Python session å…³é—­æ—¶, ä¸´æ—¶ç›®å½•ä¸­çš„ç¼“å­˜æ–‡ä»¶å°±ä¼šè¢«åˆ é™¤. å› æ­¤å½“ç¼“å­˜æœºåˆ¶å…³é—­æ—¶, åœ¨å¤„ç†å®Œæ•°æ®ä¹‹å, è¦ç”¨ `Dataset.save_to_disk()` å°†å¤„ç†åçš„æ•°æ®ä¿å­˜åˆ°æœ¬åœ°ç£ç›˜, å¦åˆ™æ‰€æœ‰çš„å¤„ç†éƒ½ä¼šåœ¨è¿›ç¨‹ç»“æŸæ—¶è¢«åˆ é™¤.

# Hashing

æ•°æ®é›†çš„ fingerprint çš„æ›´æ–°ä¼šæ ¹æ®å¤„ç†å‡½æ•°çš„ hashing, è€Œ hashing æ˜¯æ ¹æ®ä¼ å…¥åˆ° `map` æ–¹æ³•ä¸­çš„å¤„ç†å‡½æ•°, ä»¥åŠå…¶ `batch_size`, `remove_columns` ç­‰å‚æ•°å…±åŒå¾—åˆ°çš„.

å‡½æ•°çš„ hashing å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•å¾—åˆ°:

```python
from datasets.fingerprint import Hasher
my_func = lambda example: {"length": len(example["text"])}
print(Hasher.hash(my_func))
# '3d35e2b3e94c81d6'
```

hashing å…·ä½“æ˜¯é€šè¿‡ä½¿ç”¨ `dill pickler` å°†å¯¹è±¡åºåˆ—åŒ–ä¸º bytes, ç„¶åå†å¯¹åºåˆ—åŒ–å¾—åˆ°çš„ bytes è¿›è¡Œå“ˆå¸Œè®¡ç®—å¾—åˆ°. `dill pickler` é€’å½’åœ°å°†å‡½æ•°ä¸­ä½¿ç”¨åˆ°çš„å‚æ•°åºåˆ—åŒ–, æ‰€ä»¥å‡½æ•°è°ƒç”¨ä¸­ä»»ä½•ç»†èŠ‚çš„å˜åŠ¨, éƒ½ä¼šå½±å“æœ€åçš„å“ˆå¸Œå€¼.

å½“ä¸åŒçš„ Python session è°ƒç”¨æ—¶åŒä¸€ä¸ª function æœ‰ä¸åŒçš„å“ˆå¸Œå€¼, è¯´æ˜è‡³å°‘æœ‰ä¸€ä¸ªå‚æ•°åŒ…å«ä¸ç¡®å®š(not deterministic)çš„å› ç´ (æ¯”å¦‚æ˜¯åŠ¨æ€å¾—åˆ°çš„å€¼). éœ€è¦å®šä½åˆ°è¿™ä¸ªå‡½æ•°, å¹¶è§£å†³æ‰è¿™ä¸ªé—®é¢˜.

---

# å‚è€ƒèµ„æ–™

- [Datasets ğŸ¤ Arrow](https://huggingface.co/docs/datasets/main/en/about_arrow)
- [The cache](https://huggingface.co/docs/datasets/main/en/about_cache)
