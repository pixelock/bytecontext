# 输入

- PDF 文件. 文件中包含企业年报的内容, 包含**文本**和**表格**两种形式的信息
- Query 文本

# 信息抽取

需要从 PDF 中抽取需要的信息. 可以简单地将信息分为**结构化信息(表格)**和**非结构化信息(文本)**.

## 结构化信息抽取

### 有效表格筛选

并不是所有的表格都是业务关注的, 可以被使用的信息. 所以第一个需要筛选出我们使用的表格.

**方法**:

1. 设置关键词, 根据**报表名**筛选

### 表格识别

将表格中的信息转换成结构化的 JSON 格式.

1. **camelot-py**, 基于图像识别的表格信息抽取

# 问题理解

## 问题分类

### 必要性

现有的 LLM 不能很好地应对所有问题, 为了降低难度, 应当对问题进行辨别, 对于不同的问题类型, 使用不同的 pipeline 来解决, 以提升整体的表现效果.

### 方法

**模版法**

- 是否包含公司名称, 以及年份
- 是否能匹配到报表字段
- 能否匹配到公式
- 关键词

**大模型分类**

给 LLM 一个选择题, 构建的 Prompt 包含题目和选项两部分. 题目是**当前{Query}属于以下哪一类的问题**, 选项是**明确的几项问题分类**. LLM 对问题作答, 给出 A, B, C, D, E 等确定的选项.

**大模型微调**

6B 模型, 对于选择题这种 instruction 的理解和解答不够精准.

进一步提升分类的准确率, 还需要对大模型进行微调. 将比赛中的 Query 问题分为 6 类:

- 公司基本信息
- 公司员工信息
- 财务报表相关内容
- 计算题
- 统计题
- 开放性问题

微调语料构建, 使用的 Prompt 为:

```python
f"""
请问"{query}"属于下面哪个类别的问题?
A. 公司基本信息, 包含股票名称, 公司名称, 外文名称, 法定代表人, 注册地址, 办公地址, 公司网址网站, 电子信箱等.
B. 公司员工信息, 包含员工人数, 员工专业, 员工类别, 员工教育程度等.
C. ...
D. ...
E. ...
F. ...
你只需要回答字母编号, 不要回答字母编号及选项文本外的其他内容.
"""
```

每个选项除了对应的**类别名称**外, 还包含了这类问题常常包含的**关键词**, 以做出更好的引导.

### 样本数量

构建的数据集规模在**900**+条左右.

## 意图识别

### 提取要素

要素包括: 公司名称, 年份, 查询字段, 统计条件, 统计顺序, 地址等用作筛选条件的实体.

#### 提取方法

通过微调 LLM 的方法, 提取**要素字典**.

##### 准备数据集

1. 第一步, 借助 LLM 的 ICL (In-context Learning) 能力, 通过 Few-show 给出提取的示例, 提取出要素实体词.

```
你是一个提取句子要素清单的机器人，模仿给定的句子和要素清单。你要根据输入的句子，输出句子的要素清单[公司名称,查询项1,查询项2,查询项3]。
当句子中存在多个查询项要素时，以"查询项1,查询项2,查询项3"填入要素清单。'未知'表示无法确定具体的公司名称。
给定的句子为:"2021年其他流动资产第12高的是哪家上市公司?"，该句子的要素清单为:[未知,其他流动资产第12高]。
给定的句子为:"请告诉我2020年康缘药业的年报中，总资产增长率保留两位小数为多少。"，该句子的要素清单为:[康缘药业,总资产增长率]。
给定的句子为:"请简要介绍2019年宁夏宝丰能源集团股份有限公司现金流情况。"，该句子的要素清单为:[宁夏宝丰能源集团股份有限公司,现金流情况]。
针对以下的句子"{input_text}"该句子的要素清单为:
```

2. 上一步得到的实体词, 还没有跟对应的实体类型(要素类型)对应起来, 结合规则, 生成一批要素字典. 形成如下的数据集, 用于微调 LLM.

```python
{
    "instruction":"你的任务是提取用户问题中的要素，生成要素字典。用户问题中可能存在公司名称、年份、查询字段、地址、统计条件、统计顺序要素。",
    "input":"2021年货币资金最高的前3家上市公司为?",
    "output":{"公司名称":"","年份":"2021","查询字段":"货币资金","地址":"","统计条件":"前三","统计顺序":"DESC"}"
}
{
    "input":"请具体描述一下2019年五矿发展重大诉讼、仲裁事项的情况。",
    "answer":{"公司名称":"五矿发展","年份":"2019","查询字段":"重大诉讼、仲裁","地址":"","统计条件":"","统计顺序":""}
}
{
    "input":"茂业商业2021年营业成本和营业利润分别是多少元?",
    "answer":{"公司名称":"茂业商业","年份":"2021","查询字段":"营业成本,营业利润","地址":"","统计条件":"","统计顺序":""}
}
```

3. 对上面通过生成的**要素字典**进行人工抽检校验

4. 通过模版和规则, 合成一批多样化的 instruction 数据, 与上面得到的数据集组成最终的微调数据集

### 语义匹配搜索

语义匹配搜索 - 完成意图要素不明确的情况.

用户问题查询字段描述多样, 难以准确匹配数据库字段(即要素提取无法提取出最重要的**查询字段**).

通过基于**向量语义匹配搜索**, 实现对**多样化**, **不准确意图**的**模糊搜索**, 保证系统整体的泛化性和可靠性.

将提取出的意图要素(与数据库字段无法完全匹配的要素, 例如`总资产`与`资产合计`), 与数据库的所有字段计算语义向量的相似度, 召回出最相似的字段作为结果.

#### 使用的模型

- [m3e-base](https://huggingface.co/moka-ai/m3e-base)
- [训练脚本](https://github.com/wangyuxinwhy/uniem/blob/main/scripts/train_m3e.py)

### 专业领域知识库消歧

根据用户 Query 中常出现的具有歧义的词, 以及专业领域特有的词汇, 共同构建出一个词汇知识库, 将这些表达对应到数据库字段, 实现消岐.

如将 `所有者权益合计` 替换为 `净资产`.

## 文档召回

### 精准召回

#### 构建文档树

按文档结构, 构建多层级的文档树, 以每个级别的**章节标题**作为节点的代表文本.

#### 匹配召回子树

根据**意图识别**中提取出的**意图要素**, 将意图要素与文档树中的节点文本进行匹配, 可以通过:

- 精准匹配, 规则匹配
- 语义相似度匹配

实现精准召回目标章节的子树, 将子树对应的所有文本内容召回, 作为 LLM 回答的依据.

### 向量检索召回

基于子树的匹配如果没有精准召回内容, 则使用向量检索, 对全文进行匹配召回. 召回的内容是文本块, 具体文本块的粒度, 根据业务文档特点制定.

#### 文本摘要

对于包含文本内容比较多的文本块, 如果直接通过模型提取其语义向量, 得到的向量需要综合的内容太多, 最后的效果可能不会很好.

可以通过 LLM 的文本摘要能力, 提取出段落的主要意思, 然后再进行 embedding, 提升语义向量检索的能力.

# 问题应答

## 精准回答 / NL2SQL

提取到的表格信息, 存储在结构化数据库中. 对于查询一些精准回答的问题, 需要将问题转换为对应的 SQL, 在数据库中查询得到准确的答案, 按照一定的格式生成结果.

6B 模型的 NL2SQL 能力弱, 需要进一步地微调来提升这方面的能力. 需要组织训练数据集.

### 数据集构建方法

1. 通过规则生成

根据意图识别流程中, 提取得到的 查询字段, 统计条件, 统计顺序, 地址等用作筛选条件的实体, 以及根据语义匹配到的要素对数据库字段的映射, 按一定的规则, 生成 SQL 语句.

分为两种情况:

- 简单一些的. 根据计算公式(select 内容), 查询条件(条件列, 条件操作符, 条件值), 排序条件的解析值, 构建 SQL
- 复杂一些的, 带有窗口函数(over partition), 以及聚合函数(group by)

2. 通过更大的 LLM 生成

比如使用 chatgpt, codegeenx 等专业的, 或能力更强的大模型, 生成 SQL, 并进行人工校验.

3. 构建一批 SQL 模版, 随机填充字段生成. 然后通过大模型对 query 进行改写, 扩充数据集

```
[年份]年哪家公司的[指标]最高?

select 公司全称 from company_table where 年份 = '[年份]' and [指标] is not null order by [指标] desc limit 1
```

### Instruction 构建

无论是生成微调 NL2SQL 需要的训练集, 还是执行 NL2SQL 的微调, 都需要构建 Instruction.

可以采用以下的方式:

```
"你的任务是将问题转化为可以执行的sqlite语言。已知查询
的sqlite表格是'allExcel'，你应该使用表格的列是:'证券代码','证券简称',' 公司名称','**营业总收入**'"
```

数据集中的每条样本:

```python
{input:注册地址在南京的上市公司中，2021年资产总额最高的公司为?金额为?“,
output:SELECT "公司名称", "资产总计" WHERE "省市信息" LIKE '%南京%’ and "报告年份" LIKE '2021' ORDER BY “资产总计” DESC LIMIT 1 OFFSET 0}
```

#### Prompt trick

在构建 Instruction 的时候, 给模型可以使用的列, 不是将表中所有的列都通过 Instruction 给出, 而是根据要素的解析, 只给出相关的几个字段, 让模型来生成 SQL.

这样的目的是提高 prompt 的**信噪比**, 降低模型的理解难度, 提升整体的准确率.

### 数量

1k+.

